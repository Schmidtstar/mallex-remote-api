
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* Helpers */
    function signedIn() { return request.auth != null; }
    function owner(uid) { return signedIn() && request.auth.uid == uid; }
    function admin() {
      return signedIn() &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    /* Admin-Whitelist (UID-basiert) */
    match /admins/{uid} {
      // eigenes Admin-Dokument lesen dürfen (sonst permission-denied-Loop)
      allow read: if (signedIn() && request.auth.uid == uid) || admin();
      allow write: if false; // niemals vom Client schreiben
    }

    /* Nutzerprofil */
    match /users/{uid} {
      allow read, create, update: if owner(uid);
    }

    /* Spielerverwaltung (Legenden) */
    match /players/{playerId} {
      allow read, write: if signedIn() && request.auth.uid == resource.data.userId;
      allow create: if signedIn() && request.auth.uid == request.resource.data.userId;
    }

    /* Vorschläge der Nutzer (Moderation durch Admins) */
    match /suggestions/{sid} {
      allow create: if signedIn()
        && request.resource.data.category in [
          'schicksal','schande','verfuehrung','eskalation','beichte'
        ]
        && request.resource.data.text is string
        && request.resource.data.text.size() > 0
        && request.resource.data.createdBy == request.auth.uid;

      // Admins sehen alle, sonst nur eigene
      allow read: if admin() || (signedIn() && resource.data.createdBy == request.auth.uid);

      // Moderieren nur Admins
      allow update, delete: if admin();
    }

    /* Globale Aufgaben (Task-Pool) */
    match /tasks/{tid} {
      allow read: if signedIn();
      allow create, update, delete: if admin()
        && request.resource.data.category in [
          'schicksal','schande','verfuehrung','eskalation','beichte'
        ]
        && request.resource.data.text is string
        && request.resource.data.text.size() > 0;
    }

    /* Alles andere verboten */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
